import React, { useState, useEffect } from "react";
import {
  View,
  Text,
  StyleSheet,
  Image,
  TouchableOpacity,
  FlatList,
  Dimensions,
  Alert,
  Switch,
  ScrollView,
  Modal,
} from "react-native";
import { Ionicons } from "@expo/vector-icons";
import * as ImagePicker from "expo-image-picker";
import * as ImageManipulator from "expo-image-manipulator";
import * as SecureStore from "expo-secure-store";
import Animated, { FadeInDown, FadeIn } from "react-native-reanimated";
import { useAuth } from "../../src/context/AuthContext";
import { useTheme } from "../../src/context/ThemeContext";
import { useSettings } from "../../src/context/SettingsContext";
import SettingsScreen from "./Settings";

const { width } = Dimensions.get("window");
const PROFILE_IMAGE_KEY = "profile_image_uri";

const Profile = () => {
  const { user, clearUser } = useAuth();
  const { colors, toggleTheme, theme } = useTheme();
  const {
    notifications,
    sounds,
    vibration,
    language,
    toggleNotifications,
    toggleSounds,
    toggleVibration,
    changeLanguage,
    // Navigation will be handled by the AuthContext state change
  } catch (error) {
    console.error("Logout failed:", error);
  }
};

const menuItems = [
  {
    id: 1,
    type: "toggle",
    label: "Dark Mode",
    iconName: "moon",
    value: theme === "dark",
    onToggle: toggleTheme,
  },
  {
    id: 2,
    type: "toggle",
    label: "Notifications",
    iconName: "notifications",
    value: notifications,
    onToggle: toggleNotifications,
  },
  {
    id: 3,
    type: "toggle",
    label: "Sounds",
    iconName: "volume-high",
    value: sounds,
    onToggle: toggleSounds,
  },
  {
    id: 4,
    type: "toggle",
    label: "Vibration",
    iconName: "phone-portrait",
    value: vibration,
    onToggle: toggleVibration,
  },
  {
    id: 5,
    type: "link",
    label: "Settings",
    iconName: "settings",
    onPress: () => setShowSettings(true),
  },
  {
    id: 6,
    type: "logout",
    label: "Log Out",
    iconName: "log-out",
    onPress: handleLogout,
  },
];

const renderMenuItem = ({ item, index }) => (
  <Animated.View entering={FadeInDown.delay(index * 100 + 200).springify()}>
    <TouchableOpacity
      style={[styles.menuItem, { backgroundColor: colors.card }]}
      onPress={
        item.type === "toggle"
          ? item.onToggle
          : item.onPress
            ? item.onPress
            : item.type === "logout"
              ? handleLogout
              : null
      }
      activeOpacity={0.7}
    >
      <View
        style={[
          styles.menuIconContainer,
          { backgroundColor: colors.profileIconBg },
        ]}
      >
        <Ionicons
          name={item.iconName}
          size={22}
          color={colors.profilePrimary}
        />
      </View>
      <Text style={[styles.menuLabel, { color: colors.text }]}>
        {item.label}
      </Text>
      <View style={styles.menuAction}>
        {item.type === "toggle" ? (
          <Switch
            trackColor={{ false: "#767577", true: colors.profilePrimary }}
            thumbColor="#f4f3f4"
            onValueChange={item.onToggle}
            value={item.value}
          />
        ) : (
          <Ionicons
            name="chevron-forward"
            size={20}
            color={colors.textLight}
          />
        )}
      </View>
    </TouchableOpacity>
  </Animated.View>
);

return (
  <View style={[styles.container, { backgroundColor: colors.background }]}>
    <ScrollView showsVerticalScrollIndicator={false}>
      <Animated.View
        entering={FadeIn.delay(100).springify()}
        style={[styles.header, { backgroundColor: colors.profileBackground }]}
      >
        <View style={styles.headerTopRow}>
          <Ionicons name="chevron-back" size={28} color={colors.text} />
          <Text style={[styles.headerTitle, { color: colors.text }]}>
            My Profile
          </Text>
          <View style={{ width: 28 }} />
        </View>
        <View style={styles.profileInfoContainer}>
          <View style={styles.profileImageWrapper}>
            <Image
              key={imageKey}
              source={
                imageUri
                  ? { uri: imageUri }
                  : {
                    uri: "https://via.placeholder.com/150/000000/FFFFFF/?text=User",
                  }
              }
              style={styles.profileImage}
            />
            <TouchableOpacity
              onPress={pickAndCropImage}
              style={[
                styles.cameraBadge,
                { backgroundColor: colors.profilePrimary },
              ]}
            >
              <Ionicons name="camera" size={14} color="#FFF" />
            </TouchableOpacity>
          </View>
          <Text style={[styles.userName, { color: colors.text }]}>
            {user?.name ?? "Mohamed"}
          </Text>
          <Text style={[styles.userEmail, { color: colors.textLight }]}>
            {user?.email ?? "moh123@gmail.com"}
          </Text>
          <TouchableOpacity
            style={[
              styles.editProfileBtn,
              { backgroundColor: colors.profilePrimary },
            ]}
            onPress={pickAndCropImage}
          >
            <Text style={styles.editProfileText}>Edit Profile</Text>
          </TouchableOpacity>
          <View key={item.id}>{renderMenuItem({ item, index })}</View>
            ))}
        </View>
      </View>
    </ScrollView>

    <Modal
      visible={showSettings}
      animationType="slide"
      onRequestClose={() => setShowSettings(false)}
    >
      <SettingsScreen onClose={() => setShowSettings(false)} />
    </Modal>
  </View>
);
};

const styles = StyleSheet.create({
  container: { flex: 1 },
  header: {
    alignItems: "center",
    paddingHorizontal: 20,
    paddingTop: 50,
    paddingBottom: 30,
  },
  headerTopRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    width: "100%",
    marginBottom: 15,
  },
  headerTitle: { fontSize: 18, fontWeight: "600" },
  profileInfoContainer: { alignItems: "center" },
  profileImageWrapper: { position: "relative", marginBottom: 15 },
  profileImage: {
    width: 100,
    height: 100,
    borderRadius: 50,
    borderWidth: 3,
    borderColor: "#FFF",
  },
  cameraBadge: {
    position: "absolute",
    bottom: 0,
    right: 0,
    padding: 6,
    borderRadius: 20,
    borderWidth: 2,
    borderColor: "#FFF",
  },
  userName: { fontSize: 24, fontWeight: "700", marginBottom: 4 },
  userEmail: { fontSize: 14, marginBottom: 15 },
  editProfileBtn: {
    paddingHorizontal: 25,
    paddingVertical: 10,
    borderRadius: 25,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 5,
    elevation: 5,
  },
  editProfileText: { color: "#FFF", fontWeight: "bold", fontSize: 14 },
  contentSheet: {
    borderTopLeftRadius: 30,
    borderTopRightRadius: 30,
    paddingHorizontal: 25,
    paddingTop: 30,
    paddingBottom: 50,
    minHeight: 500,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: -2 },
    shadowOpacity: 0.05,
    shadowRadius: 10,
    elevation: 10,
  },
  section: { marginBottom: 25 },
  sectionTitle: { fontSize: 18, fontWeight: "bold", marginBottom: 15 },
  orderCard: {
    borderRadius: 15,
    padding: 10,
    marginRight: 15,
    alignItems: "center",
    width: 100,
  },
  orderImage: {
    width: 60,
    height: 60,
    borderRadius: 10,
    marginBottom: 8,
    backgroundColor: "#eee",
  },
  orderName: { fontSize: 12, fontWeight: "600" },
  orderPrice: { fontSize: 11, fontWeight: "bold" },
  menuItem: { flexDirection: "row", alignItems: "center", marginBottom: 20 },
  menuIconContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: "center",
    alignItems: "center",
    marginRight: 15,
  },
  menuLabel: { flex: 1, fontSize: 16, fontWeight: "500" },
  menuAction: { justifyContent: "center" },
});

export default Profile;